<objectTemplate xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3" oid="11a9fc09-9b4b-4fe3-9ff5-8c9b5a4d440f">
    <name>UserTemplate-UPEU</name>
    <description>Plantilla base para usuarios UPeU con generación automática de identificadores.</description>
    <item>
        <ref>c:name</ref>
        <mapping>
            <strength>strong</strength>
            <expression>
                <script>
                    <code><![CDATA[
import java.text.Normalizer;

def normalize(value) {
    if (value == null) {
        return "";
    }
    def normalized = Normalizer.normalize(value, Normalizer.Form.NFD)
            .replaceAll("\\p{InCombiningDiacriticalMarks}+", "");
    return normalized.replaceAll("[^A-Za-z]", "").toLowerCase();
}

def given = normalize(user.givenName)

def family = normalize(user.familyName)

def base = ""
if (!given.isEmpty()) {
    base = given.substring(0, 1)
}
base = base + family
if (base.isEmpty()) {
    base = "persona"; // TODO: ajustar fallback para nombres vacíos
}
return midpoint.generateUniqueName(base, 6);
                    ]]></code>
                </script>
            </expression>
        </mapping>
    </item>
    <item>
        <ref>c:emailAddress</ref>
        <mapping>
            <strength>strong</strength>
            <expression>
                <script>
                    <code><![CDATA[
if (user.name == null) {
    return null;
}
return user.name + "@upeu.edu.pe"; // TODO: ajustar dominio si aplica
                    ]]></code>
                </script>
            </expression>
        </mapping>
    </item>
    <item>
        <ref>c:orgRef</ref>
        <mapping>
            <strength>strong</strength>
            <expression>
                <script>
                    <code><![CDATA[
def refs = []

def archetypeOids = (user.archetypeRef ?: []).collect { it.oid }

if (archetypeOids.contains("069a118b-9317-4ca2-a4e0-7be90b1d11f8")) {
    refs.add(midpoint.createObjectRef("3cf517c2-77f2-48ad-b403-5e5d34ddc783", "OrgType"))
}
if (archetypeOids.contains("57df3e37-a749-4296-bb04-efc206209896")) {
    refs.add(midpoint.createObjectRef("a2d1f6fa-cef6-4431-b880-7a44b4daf394", "OrgType"))
}
if (archetypeOids.contains("e47dbc5a-3b6f-4c1e-8b5e-6158d60eef3d") || archetypeOids.contains("80133ef5-0e5a-46cc-bd12-0397fc5b8d1c")) {
    refs.add(midpoint.createObjectRef("9af60cf0-0109-49b4-a6c7-ec5f5e4bf2c4", "OrgType"))
}
return refs;
                    ]]></code>
                </script>
            </expression>
        </mapping>
    </item>
    <item>
        <ref>c:assignment</ref>
        <mapping>
            <strength>strong</strength>
            <expression>
                <script>
                    <code><![CDATA[
def assignments = []

def archetypeOids = (user.archetypeRef ?: []).collect { it.oid }

if (archetypeOids.contains("069a118b-9317-4ca2-a4e0-7be90b1d11f8")) {
    assignments.add(midpoint.assignmentTarget("{{OID_ROLE_STUDENT}}", "RoleType"))
}
if (archetypeOids.contains("57df3e37-a749-4296-bb04-efc206209896")) {
    assignments.add(midpoint.assignmentTarget("{{OID_ROLE_PROFESSOR}}", "RoleType"))
}
if (archetypeOids.contains("e47dbc5a-3b6f-4c1e-8b5e-6158d60eef3d") || archetypeOids.contains("80133ef5-0e5a-46cc-bd12-0397fc5b8d1c")) {
    assignments.add(midpoint.assignmentTarget("{{OID_ROLE_STAFF}}", "RoleType"))
}
return assignments;
                    ]]></code>
                </script>
            </expression>
        </mapping>
    </item>
</objectTemplate>
